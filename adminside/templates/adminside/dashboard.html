{% load static %}

{% block title %}
<title>Dashboard</title>
{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/dashboard_style.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
{% endblock %}

<div class="container-fluid dashboard-container">
    <div class="row title-row py-3">
        <div class="col-md-12 d-flex justify-content-between align-items-center">
            <h2>DASHBOARD</h2>
            {% if messages %}
            <div class="messages">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} fade show" role="alert">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Top Metrics -->
    <div class="row">
        <!-- Total Orders -->
        <div class="col-md-4">
            <div class="card p-3 dashboard-card">
                <div class="d-flex align-items-center">
                    <div class="icon-box">
                        <i class="fas fa-concierge-bell"></i><!-- ✅ Order Icon -->
                    </div>
                    <div class="ms-3">
                        <h5>Total Orders</h5>
                        <h3>{{ total_orders }}</h3>
                        <div class="progress">
                            <div class="progress-bar custom-progress" style="width: 70%;"></div> <!-- ✅ Custom Color -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Customers -->
        <div class="col-md-4">
            <div class="card p-3 dashboard-card">
                <div class="d-flex align-items-center">
                    <div class="icon-box">
                        <i class="fas fa-users"></i> <!-- ✅ Customers Icon -->
                    </div>
                    <div class="ms-3">
                        <h5>Total Customers</h5>
                        <h3>{{ total_customers }}</h3>
                        <div class="progress">
                            <div class="progress-bar custom-progress" style="width: 60%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Sales -->
        <div class="col-md-4">
            <div class="card p-3 dashboard-card">
                <div class="d-flex align-items-center">
                    <div class="icon-box">
                        <i class="fas fa-chart-line"></i> <!-- ✅ Sales Icon -->
                    </div>
                    <div class="ms-3">
                        <h5>Total Sales</h5>
                        <h3>₹ {{ total_sales|floatformat:2 }}</h3> <!-- ✅ Formatted Sales -->
                        <div class="progress">
                            <div class="progress-bar custom-progress" style="width: 80%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .dashboard-card {
            border-radius: 10px;
            background: #fff;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        }

        .icon-box {
            width: 50px;
            height: 50px;
            background: #4E598C;
            /* ✅ Icon Background */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 22px;
        }

        .progress {
            height: 6px;
            border-radius: 5px;
            margin-top: 8px;
            background: #e0e0e0;
        }

        .custom-progress {
            background-color: #FF8C42 !important;
            /* ✅ Custom Progress Bar Color */
            border-radius: 5px;
        }
    </style>


    <!-- Sales Analytics and Best Selling Items -->
    <div class="row mt-4 d-flex align-items-stretch">
        <!-- Sales Analytics -->
        <div class="col-md-8">
            <div class="card p-4 sales-analytics h-100">
                <h5>Sales Analytics</h5>
                <canvas id="salesChart"></canvas>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                var ctx = document.getElementById("salesChart").getContext("2d");

                new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: {{ sales_labels| safe }},
                datasets: [{
                    label: "Sales (₹)", /* ✅ Title centered inside chart */
                    data: {{ sales_values| safe }},
                borderColor: "#4E598C",  /* ✅ Dark blue line */
                backgroundColor: "rgba(78, 89, 140, 0.2)", /* ✅ Light blue fill */
                borderWidth: 3,
                fill: true,
                tension: 0.4  /* ✅ Smooth wavy effect */
                        }]
                    },
                options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: {
                            font: { size: 14 }, /* ❌ Removed bold */
                            color: "#000"
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: { font: { size: 14 } } /* ✅ Y-axis remains bold */
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: "top", /* ✅ Label ("Sales $") centered */
                        labels: {
                            font: { size: 14 }
                        }
                    }
                }
            }
                });
            });
        </script>

        <!-- Best Selling Items -->
        <div class="col-md-4">
            <div class="card p-3 best-selling h-100">
                <h5 class="mt-2">Best Selling Items</h5>
                <ul class="list-group list-group-flush mt-2">
                    {% for item in top_items %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <img src="{{ item.image }}" alt="{{ item.name }}" class="item-image me-2">
                            <div>
                                <strong>{{ item.name }}</strong><br>
                                <small>₹{{ item.price }}</small>
                            </div>
                        </div>
                        <span class="badge  rounded-pill" style="color: black;font-size: 15px;">{{ item.quantity}}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <!-- Total Income Pie Chart (Smaller width) -->
        <div class="col-md-3">
            <div class="card p-3 h-100 d-flex flex-column">
                <h5>Total Income Distribution</h5>
                <div class="chart-container">
                    <canvas id="incomePieChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Profit & Loss Analysis (Smaller width) -->
        <div class="col-md-3">
            <div class="card p-3 h-100 d-flex flex-column">
                <h5>Profit & Loss Analysis</h5>
                <hr>
                <div class="mt-3">
                    <p class="mb-2">
                        <strong>
                            <i class="fas fa-dollar-sign" style="color: #FF8C42; margin-right: 8px;"></i>
                            <!-- Added margin for space -->
                            Net Profit:
                        </strong>
                        ₹{{ total_profit }}
                    </p>
                    <hr>

                    <p class="mb-2">
                        <strong>
                            <i class="fas fa-chart-line" style="color: #FF8C42; margin-right: 8px;"></i>
                            Revenue:
                        </strong>
                        ₹{{ total_revenue }}
                    </p>
                    <hr>

                    <p class="mb-2">
                        <strong>
                            <i class="fas fa-file-invoice-dollar" style="color: #FF8C42; margin-right: 8px;"></i>
                            Expenses:
                        </strong>
                        ₹{{ total_cost }}
                    </p>
                    <hr>

                    <p class="mb-2">
                        <strong>
                            <i class="fas fa-percentage" style="color: #FF8C42; margin-right: 8px;"></i>
                            Profit Margin:
                        </strong>
                        {{ profit_margin }}%
                    </p>
                </div>

            </div>
        </div>

        <!-- Profit Trend Bar Chart (Larger width) -->
        <div class="col-md-6">
            <div class="card p-4 h-100 d-flex flex-column">
                <h5>Profit Trend</h5>
                <div class="chart-container">
                    <canvas id="profitChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var ctxPie = document.getElementById("incomePieChart").getContext("2d");

            var categoryLabels = {{ category_labels| safe }};
            var categoryValues = {{ category_values| safe }};
            var categoryColors = {{ category_colors| safe }};

            new Chart(ctxPie, {
                type: "pie",
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        data: categoryValues,
                        backgroundColor: categoryColors,
                    }],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: "top",  // Legend at the top inside div
                            align: "end",  // Moves it towards right
                            labels: {
                                boxWidth: 10,  // Small color box
                                usePointStyle: true,  // Circular icons
                                font: { size: 10 },  // Smaller font
                            }
                        }
                    },
                    layout: {
                        padding: 10,  // Keeps spacing clean
                    }
                }
            });

            // Profit Trend Bar Chart
            var ctxBar = document.getElementById("profitChart").getContext("2d");
            new Chart(ctxBar, {
                type: "bar",
                data: {
                    labels: {{ profit_trend_labels| safe }},
                datasets: [{
                    label: "Profit",
                    data: {{ profit_trend_values| safe }},
                backgroundColor: "#4CAF50" // Green for positive profit
                            }],
                        },
                options: {
                scales: {
                    y: { beginAtZero: true }
                }
            }
          });

        });
    </script>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/dashboard_scripts.js' %}"></script>